# 律师端聊天室后端接口对接完成

## 接口文档版本
- 接口文档版本: 12.5
- 后端服务地址: http://localhost:8081/api
- WebSocket地址: ws://localhost:8081/ws

---

## 已对接的主要接口

### 1. 获取会话列表
**接口**: `GET /api/consult/session/list`
- 请求方式: GET
- 认证: 需要 Authorization header (token)
- 返回数据结构:
```javascript
{
  "code": "00000",
  "message": "成功",
  "data": [
    {
      "sessionId": 1001,           // 会话ID
      "targetId": 2001,            // 聊天对象ID（用户看到律师，律师看到用户）
      "targetName": "张律师",      // 聊天对象名称
      "targetAvatar": "...",       // 聊天对象头像URL
      "lastMessage": "...",        // 最后一条消息
      "lastMessageTime": "...",    // 最后消息时间
      "unreadCount": 3             // 未读消息数
    }
  ]
}
```

### 2. 获取聊天记录 (分页)
**接口**: `GET /api/consult/message/list`
- 请求参数:
  - sessionId (必须): 会话ID
  - pageNum (可选): 页码，默认1
  - pageSize (可选): 每页大小，默认20
- 返回消息对象结构:
```javascript
{
  "records": [
    {
      "id": 1001,              // 消息ID
      "senderId": 2001,        // 发送者ID
      "receiverId": 3001,      // 接收者ID
      "content": "消息内容",   // 消息文本
      "type": "text",          // 消息类型 (text/image/...)
      "isRead": 0,             // 是否已读 (0=未读, 1=已读)
      "time": "2024-01-15T10:30:00Z"  // 发送时间 (ISO 8601)
    }
  ],
  "total": 50,  // 总消息数
  "current": 1, // 当前页码
  "size": 20    // 页大小
}
```

### 3. 创建会话
**接口**: `POST /api/consult/session/create`
- 请求参数:
  - lawyerId (必须): 律师ID
- 返回数据: sessionId (long)
- 说明: 用户与律师首次聊天时创建会话，若已存在则直接返回

### 4. 清除未读消息
**接口**: `PATCH /api/consult/session/clearUnread`
- 请求参数:
  - sessionId (必须): 会话ID
- 返回数据: true/false (boolean)
- 说明: 进入会话页面后，将该会话的未读数清零

### 5. WebSocket 实时消息
**连接地址**: `ws://localhost:8081/ws/{token}`
- 消息格式 (发送/接收):
```javascript
{
  "id": 1001,              // 消息ID (服务端生成)
  "sessionId": 1001,       // 会话ID
  "senderId": 2001,        // 发送者ID
  "receiverId": 3001,      // 接收者ID
  "content": "消息内容",   // 消息文本
  "type": "text",          // 消息类型
  "isRead": 0,             // 是否已读
  "time": "2024-01-15T10:30:00Z"  // 发送时间
}
```

---

## 代码实现细节

### 文件: src/api/chat.js
- `getSessionList()`: 获取会话列表
- `getMessageList(params)`: 获取分页聊天记录
- `createSession(lawyerId)`: 创建会话
- `clearUnread(sessionId)`: 清除未读消息
- `createChatSocket()`: 创建WebSocket连接

### 文件: src/stores/chat.js (Pinia Store)
**主要方法**:
- `boot()`: 初始化（加载会话、建立WebSocket连接）
- `loadSessions()`: 重新加载会话列表
- `loadMessages(sessionId, pageNum, pageSize)`: 加载分页消息
- `createSession(lawyerId)`: 创建新会话
- `openSession(sessionId)`: 打开会话（清除未读、加载消息）
- `sendMessage(data)`: 发送消息 (通过WebSocket)
  - 参数: `{ sessionId, receiverId, content, type }`
  - 自动补充: senderId (当前用户ID), time (当前时间)
- `endChat(sessionId)`: 结束会话

**状态**:
- `sessions`: 会话列表
- `messages`: 消息缓存（按sessionId索引）
- `currentSessionId`: 当前打开的会话ID
- `wsState`: WebSocket连接状态 ('closed'|'connecting'|'open')
- `totalUnread`: 计算属性，所有未读消息总数

### 文件: src/components/LawyerChatPanel.vue
**主要功能**:
- 显示会话列表（支持全部/未读过滤）
- 显示聊天消息
- 输入并发送消息
- 根据 `senderId` 判断消息来源（律师=当前用户ID，用户=其他ID）

**字段说明**:
- 消息对象使用后端接口的字段: `senderId`, `receiverId`, `content`, `type`, `isRead`, `time`
- 消息显示: senderId == 当前用户ID 时显示在左侧（律师消息），否则显示在右侧（用户消息）

---

## WebSocket 连接特性

1. **自动重连**: 连接断开时自动重连，延迟从1秒指数增长到最多30秒
2. **心跳保活**: 每20秒发送一次 `{ type: 'ping', time: Date.now() }` 保持连接
3. **认证**: 使用URL中的token进行身份认证 `ws://localhost:8081/ws/{token}`
4. **消息处理**: 接收消息自动更新本地缓存和会话列表

---

## 使用示例

### 初始化聊天
```javascript
import { useChatStore } from '@/stores/chat'

const chatStore = useChatStore()

// 启动聊天（加载会话、建立WebSocket）
await chatStore.boot()

// 打开特定会话
await chatStore.openSession(sessionId)

// 发送消息
chatStore.sendMessage({
  sessionId: 1001,
  receiverId: 2001,
  content: '你好',
  type: 'text'
})

// 结束会话
chatStore.endChat(sessionId)
```

---

## 已知限制

1. 消息更新依赖WebSocket实时推送，离线状态下消息不会实时更新
2. endChat 仅清除本地状态，后端没有专门的"结束会话"接口
3. 消息搜索、撤回等功能后端接口不可用

---

## 测试检查清单

- [x] 获取会话列表正常显示
- [x] WebSocket连接建立 (port 8081)
- [x] 消息发送/接收通过WebSocket
- [x] 消息按senderId正确显示（左/右）
- [x] 未读消息清除功能正常
- [x] 会话列表自动更新最后消息
- [x] WebSocket自动重连工作
